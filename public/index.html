<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat App</title>
    <style>
      body {
        font-family: sans-serif;
      }
      .chat {
        display: flex;
        flex-direction: column;
        height: 80vh;
        max-width: 800px;
        margin: 0 auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }
      .messages {
        flex: 1;
        overflow-y: auto;
        list-style: none;
        padding: 10px;
        margin: 0;
        background-color: #f9f9f9;
      }
      .message-item {
        margin-bottom: 10px;
        padding: 8px 12px;
        background-color: #fff;
        border-radius: 12px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }
      .message-content {
        margin-bottom: 5px;
      }
      .reactions {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
      }
      .reaction-button {
        background-color: #e0e0e0;
        border: none;
        border-radius: 15px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 0.8em;
        display: flex;
        align-items: center;
        gap: 3px;
        transition: background-color 0.2s;
      }
      .reaction-button:hover {
        background-color: #d0d0d0;
      }
      .reaction-counter {
        font-size: 0.7em;
        color: #555;
      }
      .form {
        display: flex;
        padding: 10px;
        border-top: 1px solid #eee;
        background-color: #fff;
      }
      .input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        margin-right: 5px;
      }
      .submit {
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        background: #007bff;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .submit:hover {
        background: #0056b3;
      }
      .my-message {
        text-align: right;
      }
      .my-message .message-item {
        background-color: #dcf8c6;
        margin-left: auto;
      }
      .canvas-container {
        margin-top: 20px;
        text-align: center;
      }
      #canvas {
        border: solid 1px black;
      }
    </style>
  </head>
  <body>
    <div class="chat">
      <ul class="messages"></ul>
      <form class="form">
        <input class="input" autocomplete="off" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." />
        <button class="submit">Send</button>
      </form>
    </div>

    <div class="canvas-container">
      <h3>å…±æœ‰ãŠçµµã‹ããƒœãƒ¼ãƒ‰</h3>
      <canvas id="canvas" width="600" height="400"></canvas>
    </div>

    <script>
      function main() {
        const host = location.origin.replace(/^http/, 'ws');
        const ws = new WebSocket(host + '/ws');
        const myId = self.crypto.randomUUID().substr(0, 8);

        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        ctx.lineWidth = 2; // ç·šã®å¤ªã•
        ctx.lineJoin = 'round'; // ç·šã®çµåˆéƒ¨
        ctx.lineCap = 'round'; // ç·šã®ç«¯
        ctx.strokeStyle = '#000'; // ç·šã®è‰²

        let drawing = false;

        canvas.addEventListener('mousedown', (e) => {
          drawing = true;
          sendDrawingEvent(e.offsetX, e.offsetY, 'mousedown');
        });

        canvas.addEventListener('mousemove', (e) => {
          if (drawing) {
            sendDrawingEvent(e.offsetX, e.offsetY, 'mousemove');
          }
        });

        canvas.addEventListener('mouseup', (e) => {
          drawing = false;
          sendDrawingEvent(e.offsetX, e.offsetY, 'mouseup');
        });

        canvas.addEventListener('mouseout', (e) => {
          drawing = false;
          sendDrawingEvent(e.offsetX, e.offsetY, 'mouseout');
        });

        function draw(x, y, control) {
          if (control === 'mousedown') {
            ctx.beginPath();
            ctx.moveTo(x, y);
          } else if (control === 'mousemove') {
            ctx.lineTo(x, y);
            ctx.stroke();
          } else if (control === 'mouseup' || control === 'mouseout') {
            ctx.closePath();
          }
        }

        function sendDrawingEvent(x, y, control) {
          const message = JSON.stringify({ x, y, control, type: 'paint' });
          ws.send(message);
        }

        const messageList = document.querySelector('.messages');

        ws.onmessage = (event) => {
          const msg = JSON.parse(event.data);
          if (msg.type === 'paint') {
            const { x, y, control } = msg;
            draw(x, y, control);
          } else if (msg.type === 'chat') {
            const { id, text, messageId, reactions } = msg;
            const li = document.createElement('li');
            li.classList.add('message-item');
            li.setAttribute('data-message-id', messageId);

            const messageContent = document.createElement('div');
            messageContent.classList.add('message-content');
            if (id === myId) {
              li.classList.add('my-message');
              messageContent.textContent = `(${id})è‡ªåˆ†: ` + text;
            } else {
              messageContent.textContent = id + ': ' + text;
            }
            li.appendChild(messageContent);

            const reactionsDiv = document.createElement('div');
            reactionsDiv.classList.add('reactions');

            const reactionTypes = ['good', 'bad', 'excited', 'interesting', 'sad'];
            reactionTypes.forEach(reactionType => {
              const button = document.createElement('button');
              button.classList.add('reaction-button');
              button.textContent = getReactionEmoji(reactionType); // çµµæ–‡å­—ã‚’è¨­å®š
              button.dataset.reactionType = reactionType;
              button.addEventListener('click', () => {
                ws.send(JSON.stringify({ type: 'reaction', messageId: messageId, reactionType: reactionType }));
              });

              const counterSpan = document.createElement('span');
              counterSpan.classList.add('reaction-counter');
              counterSpan.textContent = reactions[reactionType] || 0; // åˆæœŸå€¤ã‚’è¡¨ç¤º
              counterSpan.setAttribute('data-reaction-type', reactionType);

              button.appendChild(counterSpan);
              reactionsDiv.appendChild(button);
            });

            li.appendChild(reactionsDiv);
            messageList.appendChild(li);
            messageList.scrollTop = messageList.scrollHeight; // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
          } else if (msg.type === 'reactionUpdate') {
            const { messageId, reactionType, count } = msg;
            const targetMessageLi = document.querySelector(`[data-message-id="${messageId}"]`);
            if (targetMessageLi) {
              const counterSpan = targetMessageLi.querySelector(`.reaction-counter[data-reaction-type="${reactionType}"]`);
              if (counterSpan) {
                counterSpan.textContent = count;
              }
            }
          }
        }

        function getReactionEmoji(type) {
          switch (type) {
            case 'good': return 'ğŸ‘';
            case 'bad': return 'ğŸ‘';
            case 'excited': return 'ğŸ¤©';
            case 'interesting': return 'ğŸ’¡';
            case 'sad': return 'ğŸ˜¢';
            default: return '';
          }
        }

        const form = document.querySelector('.form');

        form.onsubmit = function (e) {
          e.preventDefault();
          const input = document.querySelector('.input');
          const text = input.value;
          if (text.trim() === '') return; // ç©ºã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é€ä¿¡ã—ãªã„
          ws.send(JSON.stringify({ id: myId, text, type: 'chat' }));
          input.value = '';
          input.focus();
        };

        ws.onerror = function (error) {
          console.error('WebSocket Error: ', error);
        };
      }

      main();
    </script>
  </body>
</html>
